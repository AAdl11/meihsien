<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>A* Search - Journey of Kindness</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>
    <style>
        .grid-cell {
            width: 60px;
            height: 60px;
            border: 1px solid #ccc;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: bold;
            background-size: cover;
            background-position: center;
        }
        .grid-cell:hover:not(.cell-start):not(.cell-goal) {
            background: #e0f2fe;
            transform: scale(1.05);
        }
        .cell-start {
            background: #22c55e !important;
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/8/8f/Tzu_Chi_Foundation_office.jpg/300px-Tzu_Chi_Foundation_office.jpg');
            color: white;
            font-weight: bold;
            border: 3px solid #16a34a;
        }
        .cell-goal {
            background: #ef4444 !important;
            background-image: url('https://images.unsplash.com/photo-1593113646773-028c64a8f1b8?w=300');
            color: white;
            font-weight: bold;
            border: 3px solid #dc2626;
        }
        .cell-human-path {
            background: #fbbf24 !important;
            color: #000;
        }
        .cell-ai-path {
            background: #3b82f6 !important;
            color: white;
        }
        .cell-both-path {
            background: linear-gradient(135deg, #fbbf24 50%, #3b82f6 50%) !important;
            color: white;
        }
        @keyframes celebrate {
            0%, 100% { transform: scale(1) rotate(0deg); }
            25% { transform: scale(1.2) rotate(-10deg); }
            75% { transform: scale(1.2) rotate(10deg); }
        }
        .celebrating {
            animation: celebrate 0.6s ease-in-out 3;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .ai-demo-cell {
            animation: pulse 0.8s ease-in-out;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-900 to-blue-900 min-h-screen text-white">
    
    <!-- Audio -->
    <audio id="clickSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGGS57OahUhELTKXh8bllHgU2jdXuy3UpBSh+zPDajzsKFV+16+qnVRQLRp/g8r5sIQU=" type="audio/wav">
    </audio>
    <audio id="successSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSuBzvLZiTYIGGS57OahUhELTKXh8bllHgU2jdXuy3UpBSh+zPDajzsKFV+16+qnVRQLRp/g8r5sIQU=" type="audio/wav">
    </audio>
    
    <div class="container mx-auto px-4 py-8">
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold mb-2">ğŸ—ºï¸ A* Search Algorithm</h1>
            <p class="text-xl">é£Ÿç‰©é…é€è·¯å¾‘å„ªåŒ– | Food Delivery Route Optimization</p>
            <p class="text-lg mt-2">
                å¹«åŠ©Sister Roxanneæ‰¾åˆ°å¾<strong class="text-green-300">æ…ˆæ¿Ÿæœƒæ‰€</strong>åˆ°<strong class="text-red-300">Hunters Pointé£Ÿç‰©ç™¼æ”¾ä¸­å¿ƒ</strong>çš„æœ€çŸ­è·¯å¾‘
            </p>
        </div>

        <div class="text-center mb-6">
            <button id="ai-demo-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-8 rounded-full transition text-lg shadow-lg">
                ğŸ¤– å…ˆçœ‹AIæ¼”ç¤º Watch AI Demo First
            </button>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <div class="bg-white/10 p-6 rounded-lg backdrop-blur">
                <h2 class="text-2xl font-bold mb-4">ğŸ® ä½ çš„è·¯å¾‘ Your Path</h2>
                
                <div id="instructions" class="mb-4 p-4 bg-blue-500/20 rounded">
                    <p class="font-bold">éŠæˆ²èªªæ˜:</p>
                    <ol class="list-decimal list-inside text-sm space-y-1">
                        <li>é»ğŸ¤–å…ˆçœ‹AIæ¼”ç¤º | Watch AI demo first</li>
                        <li>å¾<span class="text-green-300">ç¶ è‰²æ…ˆæ¿Ÿæœƒæ‰€</span>åˆ°<span class="text-red-300">ç´…è‰²é£Ÿç‰©ä¸­å¿ƒ</span></li>
                        <li><span class="font-bold text-yellow-300">åªèƒ½ä¸Šä¸‹å·¦å³!</span></li>
                    </ol>
                </div>

                <div id="game-board" class="inline-block bg-white/20 p-4 rounded-lg mb-4"></div>
                
                <div class="space-y-2">
                    <button id="reset-btn" class="w-full bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-6 rounded-lg">
                        ğŸ”„ é‡æ–°é–‹å§‹ Reset
                    </button>
                    <button id="submit-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-6 rounded-lg">
                        âœ… æäº¤ & æ¯”è¼ƒAI
                    </button>
                    <button id="undo-btn" class="w-full bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">
                        â†©ï¸ æ’¤éŠ·
                    </button>
                </div>

                <div id="human-stats" class="mt-4 p-4 bg-yellow-500/20 rounded-lg">
                    <p class="font-bold">ä½ çš„çµ±è¨ˆ:</p>
                    <p>è·¯å¾‘é•·åº¦: <span id="human-length" class="text-2xl font-bold">1</span> æ­¥</p>
                    <p>ç•¶å‰: <span id="human-current" class="font-mono">(0, 0)</span></p>
                </div>
            </div>

            <div class="bg-white/10 p-6 rounded-lg backdrop-blur">
                <h2 class="text-2xl font-bold mb-4">ğŸ¤– AI æœ€å„ªè§£</h2>
                
                <div id="waiting-message" class="mb-4 p-4 bg-purple-500/20 rounded-lg">
                    <p class="text-center text-lg">
                        ğŸ‘† å…ˆçœ‹AIæ¼”ç¤º<br>Watch AI demo first
                    </p>
                </div>

                <div id="ai-results" class="mb-4 p-4 bg-blue-500/20 rounded-lg hidden">
                    <p class="font-bold text-green-400 text-xl">âœ… A* Complete!</p>
                    <div class="mt-2 space-y-1">
                        <p>è·¯å¾‘: <span id="ai-length" class="text-2xl font-bold">-</span> æ­¥</p>
                        <p>æ¢ç´¢: <span id="ai-nodes" class="text-xl font-bold">-</span> ç¯€é»</p>
                    </div>
                </div>

                <div id="comparison" class="mb-4 p-4 bg-purple-500/20 rounded-lg hidden">
                    <p class="font-bold text-2xl mb-3">ğŸ“Š Human vs AI</p>
                    <div class="text-center">
                        <p class="text-sm">æ•ˆç‡:</p>
                        <p id="efficiency" class="text-5xl font-bold text-yellow-300">-</p>
                        <p id="efficiency-message" class="text-xl font-bold mt-2"></p>
                    </div>
                </div>

                <div id="console-output" class="mt-4 p-4 bg-black/50 rounded-lg font-mono text-xs overflow-auto max-h-64">
                    <p class="text-green-400 font-bold">Console:</p>
                    <div id="console-log"></div>
                </div>
            </div>
        </div>

        <div class="text-center mt-8">
            <a href="index.html" class="bg-gradient-to-r from-pink-500 to-purple-500 hover:from-pink-600 hover:to-purple-600 text-white font-bold py-3 px-8 rounded-full transition inline-block">
                â† è¿”å›ä¸»é¸å–®
            </a>
        </div>
    </div>

    <script>
        // STOP ALL AUDIO FROM INDEX.HTML
        window.addEventListener('load', () => {
            // Stop any audio from previous page
            document.querySelectorAll('audio').forEach(a => {
                a.pause();
                a.currentTime = 0;
            });
        });

        const clickAudio = document.getElementById('clickSound');
        const successAudio = document.getElementById('successSound');
        let bgMusic = null;
        let audioInit = false;
        
        function initAudio() {
            if (audioInit) return;
            audioInit = true;
            bgMusic = new Audio('music/stage1.mp3');
            bgMusic.loop = true;
            bgMusic.volume = 0.2;
            bgMusic.play().catch(e => console.log('Music blocked'));
            logConsole('ğŸµ Music started!');
        }
        
        function playClick() {
            clickAudio.currentTime = 0;
            clickAudio.volume = 0.3;
            clickAudio.play();
        }
        
        function playSuccess() {
            successAudio.currentTime = 0;
            successAudio.volume = 0.6;
            successAudio.play();
        }

        const GRID_SIZE = 8;
        let humanPath = [];
        let aiPath = [];
        let gameBoard = [];
        let pyodide = null;
        let aiDemoShown = false;
        let gameActive = false;

        const START = {x: 0, y: 0};
        const GOAL = {x: 7, y: 7};

        async function initPyodide() {
            logConsole("â³ Loading Python...");
            pyodide = await loadPyodide();
            
            await pyodide.runPythonAsync(`
import heapq

def a_star_search(start, goal, grid_size=8):
    def get_neighbors(pos):
        x, y = pos
        neighbors = []
        for dx, dy in [(0,1), (1,0), (0,-1), (-1,0)]:
            nx, ny = x + dx, y + dy
            if 0 <= nx < grid_size and 0 <= ny < grid_size:
                neighbors.append((nx, ny))
        return neighbors
    
    def manhattan(p1, p2):
        return abs(p1[0] - p2[0]) + abs(p1[1] - p2[1])
    
    open_set = []
    heapq.heappush(open_set, (0, start))
    came_from = {}
    g_cost = {start: 0}
    nodes = 0
    
    while open_set:
        _, current = heapq.heappop(open_set)
        nodes += 1
        
        if current == goal:
            path = []
            while current in came_from:
                path.append(current)
                current = came_from[current]
            path.append(start)
            path.reverse()
            return {'path': path, 'length': len(path), 'nodes_explored': nodes}
        
        for neighbor in get_neighbors(current):
            tentative_g = g_cost[current] + 1
            if neighbor not in g_cost or tentative_g < g_cost[neighbor]:
                came_from[neighbor] = current
                g_cost[neighbor] = tentative_g
                f = tentative_g + manhattan(neighbor, goal)
                heapq.heappush(open_set, (f, neighbor))
    return None
            `);
            
            logConsole("âœ… Python ready!");
        }

        async function showAIDemo() {
            if (!pyodide) {
                alert('Please wait...');
                return;
            }
            
            initAudio();
            aiDemoShown = true;
            
            logConsole("\nğŸ¤– AI Demo starting...");
            humanPath = [{x: START.x, y: START.y}];
            createBoard();
            
            const result = await pyodide.runPythonAsync(`a_star_search((${START.x}, ${START.y}), (${GOAL.x}, ${GOAL.y}), ${GRID_SIZE})`);
            const aiResult = result.toJs({dict_converter: Object.fromEntries});
            const demoPath = aiResult.path.map(p => ({x: p[0], y: p[1]}));
            
            for (let i = 0; i < demoPath.length; i++) {
                await new Promise(r => setTimeout(r, 400));
                const pos = demoPath[i];
                const cell = gameBoard[pos.y][pos.x];
                
                if (i > 0 && i < demoPath.length - 1) {
                    cell.classList.add('cell-ai-path', 'ai-demo-cell');
                    cell.textContent = i;
                    playClick();
                }
                logConsole(`AI: (${pos.x}, ${pos.y})`);
            }
            
            playSuccess();
            logConsole(`\nâœ… AI: ${demoPath.length} steps`);
            logConsole(`\nğŸ‘‰ YOUR TURN! Try to beat AI!`);
            
            alert('ğŸ¤– AIæ¼”ç¤ºå®Œæˆï¼\n\nğŸ‘‰ ç¾åœ¨è¼ªåˆ°ä½ ï¼è©¦è©¦çœ‹èƒ½å¦æ‰¾åˆ°ä¸€æ¨£çŸ­çš„è·¯å¾‘ï¼');
            
            setTimeout(() => {
                humanPath = [{x: START.x, y: START.y}];
                createBoard();
                gameActive = true;
            }, 1000);
        }

        function createBoard() {
            const board = document.getElementById('game-board');
            board.innerHTML = '';
            board.style.display = 'grid';
            board.style.gridTemplateColumns = `repeat(${GRID_SIZE}, 60px)`;
            board.style.gap = '2px';
            
            gameBoard = [];
            
            for (let y = 0; y < GRID_SIZE; y++) {
                gameBoard[y] = [];
                for (let x = 0; x < GRID_SIZE; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'grid-cell';
                    
                    if (x === START.x && y === START.y) {
                        cell.classList.add('cell-start');
                        cell.innerHTML = '<div style="background: rgba(0,0,0,0.6); padding: 2px; border-radius: 3px; font-size: 10px;">æ…ˆæ¿Ÿ</div>';
                    } else if (x === GOAL.x && y === GOAL.y) {
                        cell.classList.add('cell-goal');
                        cell.innerHTML = '<div style="background: rgba(0,0,0,0.6); padding: 2px; border-radius: 3px; font-size: 10px;">é£Ÿç‰©</div>';
                    }
                    
                    cell.addEventListener('click', () => handleCellClick(x, y));
                    board.appendChild(cell);
                    gameBoard[y][x] = cell;
                }
            }
            
            updateStats();
        }

        function handleCellClick(x, y) {
            if (!aiDemoShown) {
                alert('ğŸ‘† è«‹å…ˆçœ‹AIæ¼”ç¤ºï¼');
                return;
            }
            
            if (!gameActive) return;
            
            initAudio();
            
            if (x === START.x && y === START.y) return;
            
            // CRITICAL FIX: Allow clicking goal!
            if (humanPath.length > 0) {
                const last = humanPath[humanPath.length - 1];
                const dx = Math.abs(x - last.x);
                const dy = Math.abs(y - last.y);
                
                if ((dx === 1 && dy === 0) || (dx === 0 && dy === 1)) {
                    playClick();
                } else {
                    alert('åªèƒ½ç›¸é„°ï¼');
                    return;
                }
            }
            
            const inPath = humanPath.some(p => p.x === x && p.y === y);
            if (inPath && !(x === GOAL.x && y === GOAL.y)) {
                alert('å·²åœ¨è·¯å¾‘ä¸­ï¼');
                return;
            }
            
            humanPath.push({x, y});
            
            if (!(x === GOAL.x && y === GOAL.y)) {
                gameBoard[y][x].classList.add('cell-human-path');
                gameBoard[y][x].textContent = humanPath.length - 1;
            }
            
            updateStats();
            logConsole(`You: (${x}, ${y})`);
            
            // CHECK GOAL
            if (x === GOAL.x && y === GOAL.y) {
                gameActive = false;
                playSuccess();
                gameBoard[y][x].classList.add('celebrating');
                
                logConsole('\nğŸ‰ğŸ‰ğŸ‰ YOU REACHED GOAL!');
                logConsole('ğŸ‰ğŸ‰ğŸ‰ ä½ åˆ°é”çµ‚é»äº†ï¼');
                
                setTimeout(() => {
                    gameBoard[y][x].classList.remove('celebrating');
                    if (confirm('ğŸ‰ æ­å–œåˆ°é”çµ‚é»ï¼\nğŸ‰ Goal Reached!\n\nèˆ‡AIæ¯”è¼ƒï¼Ÿ\nCompare with AI?')) {
                        runAICompare();
                    }
                }, 1000);
            }
        }

        function updateStats() {
            document.getElementById('human-length').textContent = humanPath.length;
            if (humanPath.length > 0) {
                const last = humanPath[humanPath.length - 1];
                document.getElementById('human-current').textContent = `(${last.x}, ${last.y})`;
            }
        }

        function resetGame() {
            humanPath = [{x: START.x, y: START.y}];
            gameActive = aiDemoShown;
            createBoard();
            document.getElementById('ai-results').classList.add('hidden');
            document.getElementById('comparison').classList.add('hidden');
            logConsole("ğŸ”„ Reset!");
        }

        function undoLastStep() {
            if (humanPath.length <= 1) return;
            const removed = humanPath.pop();
            const cell = gameBoard[removed.y][removed.x];
            cell.classList.remove('cell-human-path');
            cell.textContent = '';
            updateStats();
        }

        async function runAICompare() {
            if (humanPath[humanPath.length - 1].x !== GOAL.x || humanPath[humanPath.length - 1].y !== GOAL.y) {
                alert('è«‹å…ˆåˆ°é”çµ‚é»ï¼');
                return;
            }
            
            document.getElementById('waiting-message').classList.add('hidden');
            logConsole("\nğŸ¤– Running AI...");
            
            const result = await pyodide.runPythonAsync(`a_star_search((${START.x}, ${START.y}), (${GOAL.x}, ${GOAL.y}), ${GRID_SIZE})`);
            const aiResult = result.toJs({dict_converter: Object.fromEntries});
            aiPath = aiResult.path.map(p => ({x: p[0], y: p[1]}));
            
            aiPath.forEach((pos, idx) => {
                if (idx === 0 || (pos.x === GOAL.x && pos.y === GOAL.y)) return;
                const cell = gameBoard[pos.y][pos.x];
                if (cell.classList.contains('cell-human-path')) {
                    cell.classList.add('cell-both-path');
                    cell.textContent = 'âœ“';
                } else {
                    cell.classList.add('cell-ai-path');
                    cell.textContent = 'AI';
                }
            });
            
            document.getElementById('ai-results').classList.remove('hidden');
            document.getElementById('ai-length').textContent = aiResult.length;
            document.getElementById('ai-nodes').textContent = aiResult.nodes_explored;
            
            const eff = Math.round((aiResult.length / humanPath.length) * 100);
            document.getElementById('comparison').classList.remove('hidden');
            document.getElementById('efficiency').textContent = eff + '%';
            
            let msg = '';
            if (eff === 100) {
                msg = 'ğŸ† PERFECT!';
                playSuccess();
            } else if (eff >= 90) {
                msg = 'ğŸŒŸ Excellent!';
            } else {
                msg = 'ğŸ’¡ Try again?';
            }
            document.getElementById('efficiency-message').textContent = msg;
            
            logConsole(`\nYou: ${humanPath.length} | AI: ${aiResult.length} | ${eff}%`);
        }

        function logConsole(msg) {
            const log = document.getElementById('console-log');
            const p = document.createElement('p');
            p.textContent = msg;
            log.appendChild(p);
            log.scrollTop = log.scrollHeight;
        }

        document.getElementById('ai-demo-btn').addEventListener('click', showAIDemo);
        document.getElementById('reset-btn').addEventListener('click', resetGame);
        document.getElementById('submit-btn').addEventListener('click', runAICompare);
        document.getElementById('undo-btn').addEventListener('click', undoLastStep);

        window.addEventListener('load', async () => {
            createBoard();
            await initPyodide();
            logConsole("ğŸ‘† Click ğŸ¤– to watch AI demo!");
        });
    </script>
</body>
</html>